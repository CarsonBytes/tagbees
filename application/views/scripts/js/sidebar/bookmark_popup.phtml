<script type="text/javascript">
var ns_sidebar_bookmark_poup = {
  toggleBookmark: function(bookmark_star_elem){
      var parent_li = bookmark_star_elem.parents('li');
      var id = parent_li.data('id');
      var this_popup = $('.sidebar_bookmark_popup[data-id="'+id+'"]');
      if (parent_li.hasClass("bookmarked")){
        bookmark_star_elem.removeClass('gold');
        parent_li.removeClass("bookmarked");
        this_popup.find('.white').hide();
      } else {
        bookmark_star_elem.addClass('gold');
        parent_li.addClass("bookmarked");
        this_popup.find('.sidebar_bookmark_popup_set_reminder').show();
        if (! this_popup.is(':visible')){ 
          console.log(id);
          ns_sidebar_bookmark_poup.togglePopup(id); 
        }
      }
  },
  togglePopup: function(id){
    var this_popup = $('.sidebar_bookmark_popup[data-id="'+id+'"]');
    var trigger_popup_icon = $('.trigger_popup_icon');
    if (this_popup.length){
      if ($('.sidebar_bookmark_popup').not(this_popup).is(':visible')){
        $('.sidebar_bookmark_popup, .more').not(this_popup).hide();
      }
      if (this_popup.is(':visible')){
       this_popup.hide();
       trigger_popup_icon.hide();
      }else{
       ns_sidebar_bookmark_poup.adjustSidebarPopupPosition(id);
       this_popup.show();
       trigger_popup_icon.show();
       this_popup.find('.sidebar_bookmark_popup_inner .teaser').dotdotdot({
            wrap : 'letter',
            height: 60
       });
      }
    }
  },
  adjustSidebarPopupPosition: function(id){
    var this_popup = $('.sidebar_bookmark_popup[data-id="'+id+'"]');
    var trigger_popup_icon = $('.trigger_popup_icon');
    
    var parent = $('#sidebar li[data-id="'+id+'"]');
    var grandparent = parent.parents('ul');
    
    var parent_offset = parent.offset();
    
    console.log(parent_offset)
    //init
    trigger_popup_icon.css('top', parent_offset.top + 5);
    trigger_popup_icon.css('left',grandparent.offset().left+grandparent.outerWidth( true ));
    this_popup.css('top', parent_offset.top);
    this_popup.css('left',grandparent.offset().left+grandparent.outerWidth( true )+trigger_popup_icon.outerWidth( true ));
    
    if (parent_offset.top + this_popup.height() > $(window).height() + $(window).scrollTop()){
  
      console.log('exceeded below!');
  
      if ($(window).height() < this_popup.height()){
        console.log('not enough window size!');
        this_popup.css('top', $(window).scrollTop()+5);
      }else{
        console.log('enough window size!');
        var parent_to_bottom_height = $(window).height() + $(window).scrollTop() - parent_offset.top;
        var remaining_height = this_popup.height() - parent_to_bottom_height;
        var sum = parseInt(this_popup.css('top')) - remaining_height - 5;
        this_popup.css('top', sum +'px');
      }
  
    }else if (parent_offset.top <= $(window).scrollTop()+10){
      console.log('exceeded above!');
      
      var top_to_parent_height =  parent_offset.top - $(window).scrollTop();
      
      this_popup.css('top', parent_offset.top + (10 - top_to_parent_height) +'px');
      
    }else{
      console.log('inside');
    }
    console.log(this_popup.offset());
  }
};
jQuery(function($){
  $('body').on('click', '#highlight_tab li , #reminder_tab li' , function(e) {
    e.stopPropagation();
    ns_sidebar_bookmark_poup.togglePopup($(this).data('id'));
    return false;
  })
  .on('mouseover', '#highlight_tab li, #reminder_tab li' , function(event) {
      var this_popup = $(this).find('.sidebar_bookmark_popup<?php /*, .arrow*/ ?>');
      if (! this_popup.is(':visible') && $('.sidebar_bookmark_popup<?php /*, .arrow*/ ?>').is(':visible')){
       ns_sidebar_bookmark_poup.togglePopup($(this));
      }
  })
  .on('click',".sidebar_bookmark_popup",function(e){
    e.stopPropagation();
  })
  .on('click',".star_inner",function(e){
    e.stopPropagation();
    ns_sidebar_bookmark_poup.toggleBookmark($(this));
  })
  .on('click', '.sidebar_bookmark_popup_set_reminder',function(e){
    e.stopPropagation();
    $(this).parents('.sidebar_bookmark_popup').find('.white').show();
    $(this).hide();
    $('.sidebar_bookmark_popup_reminder_title').watermark("<?php echo $this->translate('Reminder Title') ?>");
    $('.sidebar_bookmark_popup_reminder_detail').watermark("<?php echo $this->translate('Reminder Detail') ?>");
    return false;
  })
 .on('click', function(event) {
      if (!$(event.target).closest('.sidebar_bookmark_popup, .arrow, #highlight_tab li, #reminder_tab li').length) {ns_sidebar_bookmark_poup.togglePopup($('.sidebar_bookmark_popup:visible').data('id'));
      };
  });
  $('#highlight_tab ul').mousewheel(function(){
    $('.sidebar_bookmark_popup, .trigger_popup_icon').hide();
  })
<?php /* //pending hover effect...
  var over_timer;
  var out_timer;
  $('#highlight_tab li.bookmarked, #reminder_tab li.bookmarked, sidebar_bookmark_popup').hover(
    function(e){
      if ($(this).find('.sidebar_bookmark_popup, .arrow').is(':visible')) return false
      var this_elem =$(this);
      if(over_timer) {
        clearTimeout(over_timer);
        over_timer = null;
      }
      console.log('start over timer')
      over_timer = setTimeout(function() {
        if (!$(e.target).closest('.sidebar_bookmark_popup').length) {
          ns_sidebar_bookmark_poup.togglePopup(this_elem);
        }
      }, 500)
    },
    function(e){
      if (! $(this).find('.sidebar_bookmark_popup, .arrow').is(':visible')) return false
      var this_elem =$(this);
      clearTimeout(over_timer);
      if(out_timer) {
        clearTimeout(out_timer);
        out_timer = null;
      }
      console.log('start out timer')
      out_timer = setTimeout(function() {
          $('.sidebar_bookmark_popup, .arrow').hide();
      }, 500)
    }
  )*/ ?>
})  
</script>