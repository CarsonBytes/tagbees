<script type="text/javascript">
var default_feed_para = $.extend(
    true, 
    jQuery.parseJSON('<?php echo json_encode(Zend_Registry::get('config')->filter->user_para->toArray()) ?>'),
    default_feed_para
);

var maxDistance = <?php echo Zend_Registry::get('config')->filter->sys_para->max_distance ?>;
var minDistance = <?php echo Zend_Registry::get('config')->filter->sys_para->min_distance ?>;

<?php if (Zend_Auth::getInstance()->hasIdentity()){ ?>
var savedLocation=[];
var flagOverrideSavedLocation=0;
<?php } ?>

<?php /*
// prepare to fetch new feed based on updated filter input
function updateFilterByChangedInput(selector){
    if (validateSidebarSearchInputs()){
         if (selector.is('.feed_filter_input[name="is_match_location"]')){
            jQuery( ".radius_amt span#filter_radius" ).text( jQuery( "#radius_slider" ).slider( "option", "value" ));
            if (jQuery('.feed_filter_input[name="is_match_location"]').is(':checked')){
                jQuery( ".match_location_set" ).css('display','block');
                $('#locate_somewhere').prop('disabled',false);
                initDistanceWidget();
            }else{
                jQuery( ".match_location_set" ).hide();
                $('#locate_somewhere').prop('disabled',true);
                distanceWidget.set('map', null);
            }
        } else if (selector.is('.feed_filter_input[name="is_show_map"]')) {
            <?php if (Zend_Registry::get('config_ini')->server->online==1){ ?>
                    if (selector.val() == 1) {
                        $('#map_wrapper').show();
                    } else {
                        $('#map_wrapper').hide();
                    }
                    initMap();
                    return true;
            <?php } else { ?>
                var content = [{'debug' : '<?php echo $this->translate('Online mode is off. Please check application.ini to make sure server.online = 1') ?>'}] ;
                showFlashMessages(content);
            <?php } ?>
        }
    <?php if (! Zend_Auth::getInstance()->hasIdentity()) { ?>
        else if (selector.is('.feed_filter_input[name="is_match_interest"]')) {
            var content = [{'error' : '<?php echo $this->translate('To customise your own interest, please login first.') ?>'}] ;
            showFlashMessages(content);
            selector.prop('checked',false);
            return false;
        }
    <?php } ?>
    }
}
*/ ?>
function updateSortByInput(value){
    $('nav.sort_by ul li').removeClass('current');
    $('nav.sort_by ul li[data-value="'+value+'"]').addClass('current');
    $('.feed_filter_input[name="sort_by"]').val(value);
}

jQuery(function($){
  <?php if (Zend_Auth::getInstance()->hasIdentity()){ ?>
   $('body').on('click', '.match_location_set .manage_location', function(){
        jQDialog(
            '<?php echo $this->translate('save this location') ?>',
            '<?php echo $this->baseUrl('ajax/dialog/manage_location')?>',
            {},
            {
                Close: function() {
                    $( this ).dialog( "close" );
                }
            }
         );
      return false;
   }).on('click','.match_location_set .save_location',function(){
        jQDialog(
            '<?php echo $this->translate('save this location') ?>',
            '<?php echo $this->baseUrl('ajax/dialog/save_location')?>',
            {
                'title':$('.radius_amt #of').text()/*,
                'user_saved_location[]':JSON.stringify(savedLocation)*/
            },
            {
                Save: function() {
                    var dialog=$(this);
                    var location_name=$('.dialog input.save_location_name').val();
                    $.ajax({
                          type: "POST",
                          url: "<?php echo $this->baseUrl('ajax/location/save') ?>",
                            data: {
                                name:location_name,
                                lat:feed_para['lat'],
                                lng:feed_para['lng'],
                                radius:feed_para['radius'],
                                override:flagOverrideSavedLocation
                            },
                          success: function(msg){
                                if (msg['result']==1){
                                    savedLocation[location_name]=[feed_para['lat'],feed_para['lng'],feed_para['radius']];
                                    if (flagOverrideSavedLocation==0){
                                        $(".user_saved_location_list").append("<option value=\""+location_name+"\">"+location_name+"</option>")
                                        $(".user_saved_location_list option:last").prop("selected","selected");
                                    }else{
                                        flagOverrideSavedLocation=0;
                                    }
                                    dialog.dialog( "close" );
                                }else if (msg['result']==1062){
                                    $('.dialog').prepend('<p><?php echo $this->translate('same name exists in your saved locations, do you still want to override?')?></p>');
                                    flagOverrideSavedLocation=1;
                                }else{
                                    $('.dialog').prepend('<p><?php echo $this->translate('unknown error occured, please try again.')?></p>')
                                }
                            },
                        dataType:'json'
                    });

                },
                Cancel: function() {
                    $( this ).dialog( "close" );
                    flagOverrideSavedLocation=0;
                }
            }
         );
      return false;
   }).on('click', '.delete_user_saved_location', function(){
        var tr =$(this).parents('tr');
        var name=$(this).parents('tr').children('td.name').text();
        $.ajax({
              type: "POST",
              url: "<?php echo $this->baseUrl('ajax/location/delete') ?>",
                data: {
                    'name':name,
                },
              success: function(msg){
                if (msg['result']==1){
                    tr.remove();
                    if ($(".user_saved_location_list option[value='"+name+"']").is("selected"))
                        $(".user_saved_location_list option[value='last']").prop('disabled',false).prop('selected',true);
                    $(".user_saved_location_list option[value='"+name+"']").remove();
                }else{
                    $('#dialog').prepend('<p><?php echo $this->translate('unknown error occured, please try again.')?></p>')
                }
                },
            dataType:'json'
        });
        return false;
    })
   <?php } ?>
    $('input[name="is_match_interest"]+ label').qtip({
        content: {
            text: 'Please login to let us find your interest.',
            title: {
                button: false
            }
        },
        position: {
            my: 'bottom center',
            at: 'top center'
        },
        show: {
            event: 'mouseenter', delay: 100
        },
        hide: {
            event: 'mouseout'
        }
    });
    <?php /*$('.confirm_location_remove').qtip({
        content: {
            text: '<p style="text-align:center;"><img class="throbber" src="<?php echo $this->baseUrl('images/throbber.gif')?>" alt="Loading..." /></p>',
            ajax: {
                url: '<?php echo $this->baseUrl('ajax/filter/open_confirm_location_remove')?>',
                success: function(data, status) {
                    if (data.result == 'false'){
                        this.set('content.text', 'Error occured! Please try again later.');
                    } else {
                        this.set('content.text', $( "#confirm_location_remove" ).tmpl());
                    }
                }
            },
            title: {
                text: 'Confirm Location Deletion?'
            }
        },
        show: {
            event: 'click',
            modal: {
                on: true,
                effect: false
            }
        },
        position: {
            my: 'center',
            at: 'center',
            target: $(window)
        },
        style: {
            def:false,
            classes: 'qtip-light qtip-rounded'
        }
    }); <?php */ ?>
    
    $( "#radius_slider" ).slider({
        range: "min",
        //value:feed_para['radius'],
        step: 0.01,
        min: minDistance,
        max: maxDistance,
        slide: function( event, ui ) {
            $( ".radius_amt span#filter_radius" ).text( ui.value );
        },
        change: function( event, ui ) {
            $( ".radius_amt span#filter_radius" ).text( ui.value );
            if ($("#feed_filter_map").is(":visible")){
                distanceWidget.set('distance',ui.value);
                radiusWidget.bindTo('center', distanceWidget, 'position');
                map.fitBounds(radiusWidget.get('bounds'));
            }
          feed_para['radius'] = ui.value;
          updateUrlParam('radius', feed_para['radius']);
          updateUrlParam('lat', feed_para['lat']);
          updateUrlParam('lng', feed_para['lng']);
          refreshFeed();
        }
    });
    
    //show after all events are attached esp. pretty checkable takes effect...
    
    $('body').on('click','.sort_by ul li', function(){
        updateSortByInput($(this).data('value'));
        addChangedFeedInputName($('.feed_filter_input[name="sort_by"]'));
        if (validateSidebarSearchInputs()){
            for( key in changed_feed_input_names){
                updateVariableAndUrlParamFromFeedInput($('*[name="'+changed_feed_input_names[key]+'"]'));
            }
            refreshFeed('index');
        }
    }).on('change','.feed_filter_input[name="is_match_interest"]', function(){
        <?php if (Common::getSession()->user == null) { ?>
            var content = [{'error' : '<?php echo $this->translate('To customise your own interest, please login first.') ?>'}] ;
            showFlashMessages(content);
            $(this).removeAttr('checked');
            var element = $(this).parent('.prettycheckbox').find('a');
            element.delay(1000).removeClass('checked');
        <?php }else{ ?>
            addChangedFeedInputName($('.feed_filter_input[name="is_match_interest"]'));
            if (validateSidebarSearchInputs()){
                for( key in changed_feed_input_names){
                    updateVariableAndUrlParamFromFeedInput($('*[name="'+changed_feed_input_names[key]+'"]'));
                }
                refreshFeed('index');
            }
        <?php } ?>
    }).on('change','.feed_filter_input[name="is_match_location"]', function(){
        if ($(this).is(':checked')){
            jQuery('.match_location_set').css('display','block');
            initDistanceWidget();
        } else {
            jQuery('.match_location_set').css('display','none');
            distanceWidget.set('map', null);
        }
        addChangedFeedInputName($('.feed_filter_input[name="is_match_location"]'));
        if (validateSidebarSearchInputs()){
            for( key in changed_feed_input_names){
                updateVariableAndUrlParamFromFeedInput($('*[name="'+changed_feed_input_names[key]+'"]'));
            }
            refreshFeed('index');
        }
    }).on('click','.showMap', function(e){
        e.preventDefault();
        <?php if (Zend_Registry::get('config_ini')->server->online==1){ ?>
            var input = $('.feed_filter_input[name="is_show_map"]')
            if(input.prop('value') == 1){
                $(".showMap").text("Show Map").stop();
                $( "#map_wrapper" ).slideUp("slow");
                input.val(0);
            }else{
                $(".showMap").text("Hide Map").stop();
                $( "#map_wrapper" ).slideDown("slow");
                initMap();
                input.val(1);
            }
            updateVariableAndUrlParamFromFeedInput(input);
        <?php } else { ?>
            var content = [{'debug' : '<?php echo $this->translate('Online mode is off. Please check application.ini to make sure server.online = 1') ?>'}] ;
            showFlashMessages(content);
        <?php } ?>
    }).on('click','#refresh_feed', function(){
        if (feed_refreshing) return false;
        refreshFeed('index');
        changed_feed_input_names = []; // reset changed variables in search form
        return false;
    })
});

</script>
<?php if (Zend_Registry::get('config_ini')->server->online==1){
    echo $this->partial('js/filter/map.phtml');
} ?>
<?php //echo $this->partial('js/template/filter/confirm_location_remove.phtml')?>